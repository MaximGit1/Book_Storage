{% extends "base.html" %}
{% load static %}
{% load books_tags %}

{% block title %}{{ unit.title }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static "css/style-unit.css" %}">
   <div class="main">
            <div class="book">
                <img src="{{ book.image.url }}" alt="{{ book.title }}">
                <div class="Text">
                     <h1>{{ book.title }}</h1>
                    <p>Автор: {{ book.author }}</p>
                    <p>Рейтинг главы: {{ unit.total_likes }}</p>

                  <p><a href="#" data-id="{{ unit.pk }}" data-action="{% if request.user in users_like %}un{% endif %}like" class="like button">
                    {% if request.user not in users_like %}
                        Like
                    {% else %}
                        Unlike
                    {% endif %}
                </a><a href="#">
                        Добавить главу в закладки
                    </a></p>
                    <p>теги: #нет #системы #тегов</p>
                </div>
            </div>
            <div class="glav">
                <div class="unit-book">
                    <div class="img"><img src="{{ unit.image.url }}" alt="{{ unit.title }}"></div>
                </div>
                <div class="text">
                    <h1>{{ unit.title }}</h1>
                    <p>{{ unit.description }}</p>
                </div>
            </div>

            <div class="slider-wrapper">
              <div class="slider" style="transform: translateX(0%);">
                  {% for slider_review in reviews %}
                    <div class="review">
                      <div class="review-header">
                        <a href="#">
                          <img src="{{ slider_review.author.profile.photo.url }}" alt="{{ slider_review.author }}" class="avatar">
                          <span class="username">{{ slider_review.author }}</span>
                        </a>
                        <span class="rating">999</span>
                      </div>
                      <div class="review-body">
                        <p>{{ slider_review.body|markdown|truncatewords_html:34 }}</p>
                        <a href="{{ slider_review.get_absolute_url }}" target="_blank">Открыть полностью</a>
                      </div>
                      <div class="review-footer">
                        <a href="#" data-id="1" data-action="like" class="like button">Unlike</a>
                        <a href="#" data-id="1" class="follow button">Подписаться</a>
                      </div>
                    </div>
                  {% empty %}
                    <h2>No reviews</h2>
                  {% endfor %}
              </div>
            </div>

<button class="slider-prev">Назад</button>
<button class="slider-next">Вперед</button>

            <div class="user-review">
                {% if user_review %}
                    <div class="user-review">
                        <h4>Your preview</h4>
                        <p>{{ user_review.body|markdown|truncatewords_html:5 }}
                        <a href="{{ user_review.get_absolute_url }}">read</a> </p>
                    </div>
                {% else %}
                <a href="{% url "books:create_review" unit.pk %}">
                    <p>You can write a review</p>
                </a>
                {% endif %}
            </div>

    </div>

<style>
  .slider-wrapper {
    width: 100%; /* ширина слайдера */
    overflow: hidden; /* скрыть все, что выходит за пределы видимой области */
    position: relative;
  }

  .slider {
    display: flex;
    transition: transform 0.3s ease-in-out;
    width: 200%; /* Увеличить ширину для всех отзывов */
  }

  .review {
    flex: 0 0 100%; /* каждый отзыв занимает 100% видимой области */
    box-sizing: border-box;
    padding: 10px;
    border: 1px solid #ccc;
  }

  .review-header {
    display: flex;
    align-items: center;
  }

  .avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 10px;
  }

  .username {
    font-weight: bold;
  }

  .rating {
    margin-left: auto;
    font-size: 16px;
    color: #f39c12;
  }

  .review-footer {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
  }

  .button {
    color: blue;
    text-decoration: none;
    cursor: pointer;
  }
</style>

<script>
  const slider = document.querySelector('.slider');
  const reviews = document.querySelectorAll('.review');
  const prevButton = document.querySelector('.slider-prev');
  const nextButton = document.querySelector('.slider-next');
  let currentIndex = 0;

  function showSlide(index) {
    // Рассчитываем смещение слайдера в зависимости от текущего индекса
    slider.style.transform = `translateX(-${index * 100}%)`;
  }

  nextButton.addEventListener('click', () => {
    if (currentIndex < reviews.length - 1) {
      currentIndex++;
      showSlide(currentIndex);
    }
  });

  prevButton.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      showSlide(currentIndex);
    }
  });
</script>

{% endblock %}

{% block domready %}
        const url = '{% url "books:unit_like" %}';
        var options = {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
  }

  document.querySelector('a.like')
          .addEventListener('click', function(e){
    e.preventDefault();
    var likeButton = this;

    // add request body
    var formData = new FormData();
    formData.append('id', likeButton.dataset.id);
    formData.append('action', likeButton.dataset.action);
    options['body'] = formData;

    // send HTTP request
    fetch(url, options)
    .then(response => response.json())
    .then(data => {
      if (data['status'] === 'ok')
      {
        var previousAction = likeButton.dataset.action;

        // toggle button text and data-action
        var action = previousAction === 'like' ? 'unlike' : 'like';
        likeButton.dataset.action = action;
        likeButton.innerHTML = action;

        // update like count
        var likeCount = document.querySelector('span.count .total');
        var totalLikes = parseInt(likeCount.innerHTML);
        likeCount.innerHTML = previousAction === 'like' ? totalLikes + 1 : totalLikes - 1;
      }
    })
  });











{% endblock %}
